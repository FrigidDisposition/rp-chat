<!-- === RP Chat App with Dynamic Rooms (Dark Modern Style) === -->
<!DOCTYPE html>
<html>
<head>
  <title>RP Chat (Rooms)</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

    body {
      display: flex;
      font-family: 'Roboto Mono', monospace;
      margin: 0;
      background-color: #121212;
      color: #e0e0e0;
    }

    #sidebar {
      width: 220px;
      background: #1e1e1e;
      padding: 10px;
      border-right: 2px solid #2a2a2a;
      height: 100vh;
      box-sizing: border-box;
    }

    #main {
      flex: 1;
      padding: 20px;
      background-color: #1a1a1a;
    }

    #messages {
      list-style: none;
      height: 300px;
      overflow-y: scroll;
      padding: 10px;
      border: 1px solid #2c2c2c;
      background: #1e1e1e;
      margin-bottom: 10px;
    }

    #messages li {
      padding: 6px;
      border-bottom: 1px solid #2a2a2a;
    }

    .room {
      cursor: pointer;
      margin: 5px 0;
      padding: 5px;
      border-radius: 3px;
      color: #90caf9;
      transition: background 0.2s;
    }

    .room:hover {
      background-color: #2b2b2b;
    }

    .room.active {
      font-weight: bold;
      background-color: #333;
      color: #ffffff;
    }

    input, button {
      background: #2a2a2a;
      color: #e0e0e0;
      border: 1px solid #444;
      padding: 6px 10px;
      margin-right: 4px;
      border-radius: 3px;
    }

    input::placeholder {
      color: #888;
    }

    button:hover {
      background-color: #444;
      cursor: pointer;
    }

    #room-title {
      margin-top: 0;
      color: #90caf9;
    }

    .user-list {
  margin-top: 10px;
  background-color: #181818;
  border: 1px solid #2d2d2d;
  border-radius: 8px;
  padding: 10px;
  max-height: 200px;
  overflow-y: auto;
  font-family: 'Trebuchet MS', sans-serif;
}

.user-list li {
  padding: 6px 10px;
  margin-bottom: 4px;
  background: linear-gradient(to right, #2e2e2e, #1c1c1c);
  border-radius: 5px;
  color: #d6d6d6;
  font-weight: 500;
  box-shadow: 0 0 4px rgba(100, 100, 255, 0.3);
  transition: background 0.3s;
}

.user-list li:hover {
  background: #333;
  cursor: default;
}

    textarea#m {
  width: 60%;
  resize: none;
  overflow: hidden;
  min-height: 30px;
  max-height: 150px;
  background: #2a2a2a;
  color: #e0e0e0;
  border: 1px solid #444;
  border-radius: 3px;
  padding: 6px 10px;
  font-family: inherit;
  font-size: 14px;
}

  </style>
</head>
<body>
  <div id="sidebar">
    <h4>Rooms</h4>
    <div id="room-list"></div>
    <input id="new-room" placeholder="New room name" />
    <button onclick="createRoom()">Create</button>
    <h4 style="margin-top: 20px;">Users in Room</h4>
<ul id="user-list" class="user-list"></ul>
    <h4>Users in Room</h4>
<ul id="user-list" style="list-style: none; padding: 0;"></ul>
  </div>

  <div id="main">
    <h2 id="room-title">Room: lobby</h2>
    <ul id="messages"></ul>
    <input id="username" placeholder="Name" />
    <input id="color" type="color" value="#2ecc71" />
    <textarea id="m" rows="1" placeholder="Message"></textarea>
    <button onclick="send()">Send</button>
  </div>

  <script>
    const socket = io();
    let currentRoom = "lobby";

    const messages = document.getElementById('messages');
    const roomList = document.getElementById('room-list');
    const roomTitle = document.getElementById('room-title');

    function joinRoom(room) {
      socket.emit('set username', localStorage.getItem('username'));
      currentRoom = room;
      messages.innerHTML = '';
      roomTitle.textContent = 'Room: ' + room;
      document.querySelectorAll('.room').forEach(r => r.classList.remove('active'));
      const active = document.getElementById('room-' + room);
      if (active) active.classList.add('active');
    }

    function addRoomToList(room) {
      if (!document.getElementById('room-' + room)) {
        const div = document.createElement('div');
        div.className = 'room';
        div.id = 'room-' + room;
        div.textContent = room;
        div.onclick = () => joinRoom(room);
        roomList.appendChild(div);
      }
    }

function createRoom() {
  const room = document.getElementById('new-room').value.trim();
  if (room) {
    socket.emit('create room', room); // Let server handle adding + broadcasting
    document.getElementById('new-room').value = '';
  }
}

socket.on('user list', function(users) {
  const userList = document.getElementById('user-list');
  userList.innerHTML = '';
  users.forEach(name => {
    const li = document.createElement('li');
    li.textContent = name;
    userList.appendChild(li);
  });
});


    socket.on('chat message', function(msg) {
      if (msg.room !== currentRoom) return;
      const li = document.createElement('li');
      const styledText = formatQuotedText(msg.text, msg.color);
      li.innerHTML = `<strong>${msg.user}:</strong> ${styledText}`;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    });

    // Add rooms that are broadcast from the server
socket.on('new room', (room) => {
  addRoomToList(room);
});

// On first connect, receive existing rooms
socket.on('room list', (rooms) => {
  roomList.innerHTML = '';
  rooms.forEach(addRoomToList);
});


    function send() {
      const user = document.getElementById('username').value;
      const text = document.getElementById('m').value;
      const color = document.getElementById('color').value;
      if (user && text) {
        socket.emit('chat message', { user, text, color, room: currentRoom });
        document.getElementById('m').value = '';
      }
    }
    
    const messageInput = document.getElementById('m');

messageInput.addEventListener('input', () => {
  messageInput.style.height = 'auto';
  messageInput.style.height = messageInput.scrollHeight + 'px';
});


    function formatQuotedText(text, color) {
      return text.replace(/"([^"\r\n]+)"/g, `<span style=\"color: ${color}\">"$1"</span>`);
    }
    // ðŸ‘‡ Add this line below socket.on('chat message', ...) block
socket.on('chat history', function(history) {
  messages.innerHTML = '';
  history.forEach(msg => {
    const li = document.createElement('li');
    const styledText = formatQuotedText(msg.text, msg.color);
    li.innerHTML = `<strong>${msg.user}:</strong> ${styledText}`;
    messages.appendChild(li);
  });
  messages.scrollTop = messages.scrollHeight;
});


    // Init
    ['lobby'].forEach(addRoomToList);
    joinRoom('lobby');
  </script>
</body>
</html>
